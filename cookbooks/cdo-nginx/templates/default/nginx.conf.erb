user www-data;
worker_processes auto;
pid /run/nginx.pid;

events {
  worker_connections 1024;
  use epoll;
}

http {
  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  types_hash_max_size 2048;

  include /etc/nginx/mime.types;
  default_type application/octet-stream;

  access_log /var/log/nginx/access.log;
  error_log /var/log/nginx/error.log;
  proxy_redirect off;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Request-Start "t=${msec}";
  proxy_set_header Host $http_host;
  # Copy Accept-Language header to X-Varnish-Accept-Language.
  # TODO: Update application code to read Accept-Language instead of X-Varnish-Accept-Language.
  proxy_set_header X-Varnish-Accept-Language $http_accept_language;
  proxy_buffer_size 8k;

  client_max_body_size 4G;
  keepalive_timeout 30;

  server {
<% unless node['cdo-varnish']['enabled'] -%>
    listen 80 deferred;
<% end -%>
    listen <%= node['cdo-apps']['dashboard']['port'] %> deferred;
    server_name ~(dashboard|studio);
    location / {
      proxy_pass http://unix:<%= @run_dir %>/dashboard.sock;
    }
  }
  server {
<% unless node['cdo-varnish']['enabled'] -%>
    listen 80 default_server deferred;
<% end -%>
    listen <%= node['cdo-apps']['pegasus']['port'] %> deferred;
    server_name pegasus_proxy;
    location / {
      proxy_pass http://unix:<%= @run_dir %>/pegasus.sock;
    }
  }
  server {
    server_name ssl_proxy;
    listen 443 ssl;
    <%= render 'nginx.erb', cookbook: 'ssl_certificate' %>
    location / {
      # Pass the request on to port 80.
      proxy_pass  http://127.0.0.1;
      proxy_set_header X-Forwarded-Proto https;
    }
  }
<% unless node['cdo-varnish']['enabled'] -%>
<%   node['cdo-varnish']['redirects'].dup.each_pair do |domain, site| -%>
  server {
    listen 80 deferred;
    server_name <%=domain%>;
    return 301 https://<%=site%>$request_uri;
  }
<%   end -%>
<% end -%>
}
