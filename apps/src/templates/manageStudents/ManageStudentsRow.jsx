import React, {useState} from 'react';
import PropTypes from 'prop-types';
import {tableLayoutStyles} from '../tables/tableConstants';
import i18n from '@cdo/locale';
import {scriptUrlForStudent} from '@cdo/apps/templates/teacherDashboard/urlHelpers';
import {studentSectionDataPropType} from './manageStudentsTypes';
import PasswordReset from './PasswordReset';
import ShowSecret from './ShowSecret';
import {SectionLoginType} from '@cdo/apps/util/sharedConstants';
import {ages} from '../AgeDropdown';
import Button from '../Button';
import {currentEditingStudentsVar} from '@cdo/apps/templates/teacherDashboard/controller';

const ManageStudentsRow = props =>
  props.student.isEditing ? <WriteRow {...props} /> : <ReadRow {...props} />;
ManageStudentsRow.propTypes = {
  sectionId: PropTypes.string.isRequired,
  student: studentSectionDataPropType.isRequired,
  loginType: PropTypes.string.isRequired
};

export default ManageStudentsRow;

const ReadRow = props => {
  const {student, sectionId} = props;
  const studentUrl = scriptUrlForStudent(sectionId, 'test-script', student.id);
  return (
    <tr>
      <td>
        <a
          style={tableLayoutStyles.link}
          href={studentUrl}
          target="_blank"
          rel="noopener noreferrer"
        >
          {student.name}
        </a>
        <div style={styles.details}>
          {i18n.usernameLabel() + student.username}
        </div>
        {student.email && (
          <div style={styles.details}>{i18n.emailLabel() + student.email}</div>
        )}
      </td>
      <td>{student.age}</td>
      <td>{GENDERS[student.gender]}</td>
      <td>
        <PasswordCell {...props} />
      </td>
      <td>
        <Button
          __useDeprecatedTag
          onClick={() => setIsEditingStudent(student.id, true)}
          color={Button.ButtonColor.gray}
          text={i18n.edit()}
        />
      </td>
    </tr>
  );
};
ReadRow.propTypes = ManageStudentsRow.propTypes;

const WriteRow = ({student}) => {
  const [formState, setFormState] = useState({
    name: student.name,
    age: student.age,
    gender: student.gender
  });
  return (
    <tr>
      <td style={tableLayoutStyles.cell}>
        <input
          required
          value={formState.name || ''}
          style={styles.inputBox}
          onChange={e =>
            setFormState({
              ...formState,
              name: e.target.value
            })
          }
          placeholder={i18n.nameRequired()}
        />
      </td>
      <td>
        <select
          style={{width: 50}}
          value={formState.age || ''}
          onChange={e =>
            setFormState({
              ...formState,
              age: e.target.value
            })
          }
        >
          {ages.map(age => (
            <option key={age} value={age}>
              {age}
            </option>
          ))}
        </select>
      </td>
      <td>
        <select
          value={GENDERS[formState.gender]}
          onChange={e =>
            setFormState({
              ...formState,
              gender: e.target.value
            })
          }
          style={{width: 120}}
        >
          {Object.keys(GENDERS).map(gender => (
            <option key={gender} value={gender}>
              {GENDERS[gender]}
            </option>
          ))}
        </select>
      </td>
      <td>{i18n.autoGenerated()}</td>
      <td>
        <Button
          __useDeprecatedTag
          onClick={() => setIsEditingStudent(student.id, false)}
          color={Button.ButtonColor.orange}
          text={i18n.save()}
          disabled={!formState.name}
          style={styles.saveButton}
        />
        <Button
          __useDeprecatedTag
          onClick={() => setIsEditingStudent(student.id, false)}
          color={Button.ButtonColor.gray}
          text={i18n.cancel()}
        />
      </td>
    </tr>
  );
};
WriteRow.propTypes = ManageStudentsRow.propTypes;

const PasswordCell = ({student, sectionId, loginType}) => {
  return (
    <React.Fragment>
      {loginType === SectionLoginType.email && (
        <PasswordReset
          initialIsResetting={false}
          sectionId={sectionId}
          studentId={student.id}
          resetDisabled={student.userType === 'teacher'}
        />
      )}
      {(loginType === SectionLoginType.word ||
        loginType === SectionLoginType.picture) && (
        <ShowSecret
          initialIsShowing={false}
          secretWord={student.secretWords}
          secretPicture={student.secretPicturePath}
          loginType={loginType}
          id={student.id}
          sectionId={sectionId}
          resetDisabled={canEdit(student.userType)}
        />
      )}
    </React.Fragment>
  );
};
PasswordCell.propTypes = ManageStudentsRow.propTypes;

/**
 * Editing is disabled if the "student" in the section is a teacher
 * (e.g., their userType is 'teacher').
 */
const canEdit = userType => userType !== 'teacher';

const setIsEditingStudent = (studentId, isEditing) => {
  currentEditingStudentsVar({
    ...currentEditingStudentsVar(),
    [studentId]: isEditing
  });
};

const GENDERS = {
  '': '',
  m: i18n.genderMale(),
  f: i18n.genderFemale(),
  n: i18n.genderNonBinary(),
  o: i18n.genderNotListed()
};

const styles = {
  inputBox: {
    width: 225
  },
  details: {
    fontSize: 12
  },
  saveButton: {
    marginRight: 5
  }
};
